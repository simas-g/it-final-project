generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum InventoryAccessType {
  READ
  WRITE
}

enum FieldType {
  SINGLE_LINE_TEXT
  MULTI_LINE_TEXT
  NUMERIC
  IMAGE_URL
  BOOLEAN
}

enum CustomIdElementType {
  FIXED_TEXT
  RANDOM_20BIT
  RANDOM_32BIT
  RANDOM_6DIGIT
  RANDOM_9DIGIT
  GUID
  DATE_TIME
  SEQUENCE
}

model UserPreferences {
  id       String @id @default(uuid())
  userId   String @unique
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  language String @default("en")
  theme    String @default("light")
}

model Category {
  id          String      @id @default(uuid())
  name        String      @unique
  inventories Inventory[]
}

model Tag {
  id          String         @id @default(uuid())
  name        String         @unique
  inventories InventoryTag[]
}

model InventoryTag {
  id          String    @id @default(uuid())
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  tagId       String
  tag         Tag       @relation(fields: [tagId], references: [id])

  @@unique([inventoryId, tagId])
}

model InventoryField {
  id          String    @id @default(uuid())
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  title       String
  description String?
  fieldType   FieldType
  isRequired  Boolean   @default(false)
  showInTable Boolean   @default(true)
  order       Int
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  fieldValues ItemFieldValue[]
}

model CustomIdConfig {
  id           String            @id @default(uuid())
  inventoryId  String            @unique
  inventory    Inventory         @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  elements     Json
  elementsList CustomIdElement[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
}

model CustomIdElement {
  id          String              @id @default(uuid())
  configId    String
  config      CustomIdConfig      @relation(fields: [configId], references: [id], onDelete: Cascade)
  elementType CustomIdElementType
  format      String
  value       String?
  order       Int
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
}

model InventoryAccess {
  id          String              @id @default(uuid())
  inventoryId String
  inventory   Inventory           @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  userId      String
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessType  InventoryAccessType @default(READ)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@unique([inventoryId, userId])
}

model DiscussionPost {
  id          String    @id @default(uuid())
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  content     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model ItemLike {
  id     String        @id @default(uuid())
  itemId String
  item   InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  userId String
  user   User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([itemId, userId])
}

model User {
  id         String   @id @default(uuid())
  email      String   @unique
  name       String?
  password   String?
  provider   String?
  providerId String?
  isBlocked  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  role       UserRole @default(USER)

  preferences     UserPreferences?
  inventories     Inventory[]
  items           InventoryItem[]
  inventoryAccess InventoryAccess[]
  discussionPosts DiscussionPost[]
  itemLikes       ItemLike[]
}

model Inventory {
  id          String    @id @default(uuid())
  name        String
  description String?
  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  imageUrl    String?
  isPublic    Boolean   @default(false)
  version     Int       @default(1)
  apiTokenHash        String?
  apiTokenGeneratedAt DateTime?
  apiTokenLastUsedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  items           InventoryItem[]
  inventoryAccess InventoryAccess[]
  inventoryTags   InventoryTag[]
  fields          InventoryField[]
  customIdConfig  CustomIdConfig?
  discussionPosts DiscussionPost[]
}

model InventoryItem {
  id          String    @id @default(uuid())
  inventoryId String
  inventory   Inventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  customId    String?
  version     Int       @default(1)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes       ItemLike[]
  fieldValues ItemFieldValue[]

  @@unique([inventoryId, customId])
}

model ItemFieldValue {
  id       String         @id @default(uuid())
  itemId   String
  item     InventoryItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)
  fieldId  String
  field    InventoryField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  value    String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([itemId, fieldId])
}
